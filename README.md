# stripe-eccube-4-recurring-v1

Copyright Subspire Inc. 2020

[EC-CUBE](http://www.ec-cube.net)用の[Stripe](https://stripe.com/)の決済プラグインを元に定期購入を行えるようにする拡張プラグインです。

このプラグインはEC-CUBE上での定期購入機能を提供します。
定期購入のみを行うシンプルなプラグインで、受注や集計はEC-CUBEで管理する方針です。
購入者のクレジットカード情報はデータベースに保存せず、ショップのオーナーも見ることはできません。

## 機能

- 定期購入商品の登録（管理画面）
- 定期購入商品の注文（フロント側）
- 定期購入注文の解約（フロント側・管理画面）
- 定期購入初期費用の設定
- 定期購入初期請求タイミングの設定
- Stripeクーポン機能

## 対応環境

- EC-CUBE 4.0.0 以上

## インストール方法

1) Stripe決済プラグインが有効になってて設定済みであることをご確認ください。
本プラグインはStripe決済プラグインの拡張プラグインで、Stripe決済プラグインが有効になってて設定済みでないとうまく動作しません。

Stripe 決済プラグイン EC-CUBE 4
https://subspire.co.jp/product/stripe-ec-cube-4-secure/

2) プラグインを管理画面からインストールします。

```
2-1) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】から
【アップロードして新規追加】のボタンをクリックしていただいて、その後本プラグインのZIPファイルを
選択していただいて、アップロードしていただけます。

2-2) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】から
【Stripe 決済プラグイン】の【有効にする】をクリックしてください。

2-3) EC-CUBE管理画面の【コンテンツ管理】→【キャッシュ管理】で【キャッシュ削除】を押していただきキャッシュをクリアしてください。

2-4) EC-CUBE管理画面の【Stripe管理】→【定期支払い設定】にてライセンスキーとご購入時にご利用いただいたメールアドレスをご入力ください。
ライセンス認証は1回だけ行えます。先にテスト用でご利用いただく場合はStripe 決済プラグインの方でテストモードに設定していただければライセンス認証の画面を飛ばしてテストモードでご利用いただけます。
また、追加分のライセンスキーが必要でしたら弊社までご連絡ください。1ライセンスにつき一つのEC-CUBE環境でご利用いただけます。

2-5) EC-CUBE管理画面の【Stripe管理】→【定期支払い設定】にある【Webhook URL】をStripe管理画面の【Developers】→【Webhooks】ページで登録を行ってください。
必要なイベント種類は下記です。

invoice.payment_succeeded
invoice.paid
invoice.payment_failed
invoice.upcoming
invoice.finalized
customer.subscription.deleted
customer.subscription.updated
checkout.session.completed                
customer.subscription.created
subscription_schedule.canceled
                

登録後は【Webhook署名シークレット】をご確認いただき、EC-CUBE管理画面の【Stripe管理】→【定期支払い設定】で【Webhook署名シークレット】の登録を行ってください。

2-6) EC-CUBE管理画面の【設定】→【店舗設定】→【配送方法設定】から対象になる配送方法で【クレジットカード定期購入】のチェックを入れて保存してください。
定期購入用の商品は定期購入の決済方法のみ提供する場合は定期購入用の配送方法を追加していただいて、その配送方法は【クレジットカード定期購入】のみ選択してください。
そして、Apple Pay / Google Payの定期購入を提供する場合は【Apple Pay / Google Pay定期購入】を選択してください。

その後、本プラグインをご利用いただけるようになります。
```

## アップデート方法

旧バージョンからのアップデート方法が下記になります。アップデート時は必ず下記の手順でアップデートをお願いいたします。

1) プラグインを管理画面から更新します。

```
1-1) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】からプラグインを無効にします。

1-2) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】からプラグインを更新します。

1-3) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】からプラグインを有効にします。

1-4) EC-CUBE管理画面の【コンテンツ管理】→【キャッシュ管理】で【キャッシュ削除】を押していただきキャッシュをクリアしてください。
```

## 利用方法

- EC-CUBE管理画面の【設定】→【店舗設定】→【配送方法設定】から対象になる配送方法で【クレジットカード定期購入】のチェックを入れて保存してください。
定期購入用の商品は定期購入の決済方法のみ提供する場合は定期購入用の配送方法を追加していただいて、その配送方法は【クレジットカード定期購入】のみ選択してください。
そして、Apple Pay / Google Payの定期購入を提供する場合は【Apple Pay / Google Pay定期購入】を選択してください。

- 商品編集画面でプランIDにある商品登録を行ってください。

- 商品規格設定で規格ごとに継続課金の頻度を設定してください。

- テスト環境では[テストカード](https://stripe.com/docs/testing)を利用して試すことが可能です。